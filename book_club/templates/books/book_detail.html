<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ book.title }} - Book Details</title>

    <!-- Load the external CSS file -->
    <link
      rel="stylesheet"
      type="text/css"
      href="{% static 'books/styles.css' %}"
    />
  </head>
  <body>
    {% if messages %}
    <ul class="messages">
      {% for message in messages %}
      <li class="{% if message.tags %}{{ message.tags }}{% endif %}">
        {{ message }}
      </li>
      {% endfor %}
    </ul>
    {% endif %}

    <div class="book-container">
      <!-- Book Title -->
      <h1>{{ book.title }}</h1>

      <!-- Book Author -->
      <p><strong>Author:</strong> {{ book.author }}</p>

      <!-- Book Genre -->
      <p><strong>Genre:</strong> {{ book.genre }}</p>

      <!-- Book Description -->
      <p><strong>Description:</strong> {{ book.description }}</p>

      <!-- If the user is logged in, show the review form -->
      {% if user.is_authenticated %}

      <form method="POST">
        <!-- Include CSRF token for security -->
        {% csrf_token %}
        <!-- Render the review form fields as paragraphs -->
        {{ review_form.as_p }}

        <!-- Submit button for adding a review -->
        <button type="submit" name="add_review">Add Review</button>
      </form>

      <!-- If the user is not logged in, display a login prompt -->
      {% else %}
      <p><a href="{% url 'login' %}">Log in</a> to leave a review.</p>
      {% endif %}

      <!-- Reviews Section -->
      <h2>Reviews</h2>
      <ul>
        {% for review in reviews %}
        <li>
          <strong>{{ review.user.username }}</strong> ({{ review.rating }}/5):
          {{ review.review_text }}
          <em>({{ review.created_at }})</em>

          {% if user == review.user %}
          <!-- Form for deleting the review -->
          <form
            method="POST"
            action="{% url 'delete_review' book.slug review.id %}"
            style="display: inline"
          >
            {% csrf_token %}
            <button type="submit" name="delete_review">Delete</button>
          </form>
          {% endif %}
        </li>
        {% empty %}
        <li>No reviews yet.</li>
        {% endfor %}
      </ul>

      <!-- Link to go back to the Book List -->
      <p>
        <a href="{% url 'books_view' %}">Back to Book List</a>
      </p>
    </div>

    <script>
      // JavaScript for delete confirmation
      document.addEventListener("DOMContentLoaded", function () {
        const deleteButtons = document.querySelectorAll(
          'form button[name="delete_review"]'
        );

        deleteButtons.forEach((button) => {
          button.addEventListener("click", function (event) {
            const confirmDelete = confirm(
              "Are you sure you want to delete this review?"
            );
            if (!confirmDelete) {
              event.preventDefault(); // Cancel the deletion if the user clicks "Cancel"
            }
          });
        });
      });
    </script>
  </body>
</html>
